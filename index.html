<!DOCTYPE html>
<!-- saved from url=(0024)https://cyborg.tenso.rs/ -->
<html>
<link type="text/css" id="dark-mode" rel="stylesheet" href="https://cyborg.tenso.rs/">
<style type="text/css" id="dark-mode-custom-style"></style>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="shortcut icon" href="./medtype_ui/images/plus.jpg">
    <title>MedType</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="An experimental text editor with an embedded neural text synthesizer.">
    <meta name="keywords" content="neural,text,editor,autocomplete,prediction,generator,neural network,tensorfire">
    <meta name="author" content="Kevin Kwok">
    <link href="./medtype_ui/main.0a40c150.chunk.css" rel="stylesheet">
    <link rel="stylesheet" href="./medtype_ui/codemirror.css">
    <link rel="stylesheet" href="./medtype_ui/style.css">
    <script type="text/javascript" async="" src="./medtype_ui/analytics.js"></script>
    <script charset="utf-8" src="./medtype_ui/button.a9e51eea566eab199c00950f37200d0b.js"></script>
</head>

<body data-gr-c-s-loaded="true">
    <div id="fb-root" class=" fb_reset">
        <div style="position: absolute; top: -10000px; width: 0px; height: 0px;">
            <div></div>
        </div>
    </div>
    <script src="./medtype_ui/sdk.js" async="" crossorigin="anonymous"></script>
    <script id="facebook-jssdk" src="./medtype_ui/sdk(1).js"></script>
    <script>
        (function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = 'https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.10&appId=234263839953649';
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
    <div id="container">
        <div id="preamble">
            <a href="https://github.com/svjan5/medtype" class="github-corner" aria-label="View source on Github">
                <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#4a4a4a; color:white; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
                    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                    <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
                </svg>
            </a>
            <style>
                .github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}
            </style>
            
            <center>
                <img src="./medtype_ui/images/logo_noback.png" align="top middle" alt="centered image" style="width: 25em;">
                <p><a href="https://arxiv.org/abs/2005.00460">Improving Medical Entity Linking with Semantic Type Prediction </a></p>
                <!-- <img src="./medtype_ui/images/overview.png" align="top middle" alt="centered image" style="width: 50em;"> -->
            </center>
            <!-- <p>MedType is a BERT-based entity disambiguation module which can be incorporated with an any existing medical entity linker for enhancing its performance. For a given input text, MedType takes in the set of identified mentions along with their list of candidate concepts as input. Then, for each mention MedType predicts its semantic type based on its context in the text. The identified semantic type is utilized to disambiguate extracted mentions by filtering the candidate concepts. The results demonstrate that MedType achieves state-of-the-art performance for medical entity linking task. Please refer to the paper for more details.</p>             -->
        </div>
        <div id="workaround">
            <div id="toolbar" style="">

                <span class="spacer"></span>
                <span id="weirdness-stuff" class="spacer"> Entity Linker:
                    <select id="linker_picker" value="linker" onchange="call_linker()">
                        <option value="scispacy">ScipaCy</option>
                        <option value="ctakes">cTakes</option>
                        <option value="metamap">MetaMap</option>
                        <option value="metamaplite">MetaMapLite</option>
                        <option value="quickumls">QuickUMLS</option>
                    </select>
                </span>
                <!-- <span class="spacer"></span> -->

                <span id="weirdness-stuff" class="spacer"> MedType Model:
                    <select id="model_picker" value="model" onchange="call_linker()">
                        <option value="general_model">General Text</option>
                        <option value="pubmed_model">BioMedical Research</option>
                        <option value="ehr_model">Electronic Health Records</option>
                    </select>
                </span>
                <span class="spacer"></span>

            
                <!-- <span id="weirdness-stuff"> Threshold:
                    <input id="threshold" oninput="document.getElementById(&#39;temp&#39;).innerHTML = (+this.value).toFixed(2)" onchange="updateCompletion()" type="range" style="width: 300px" value="0.5" min="0.0" max="1" step="0.01">
                    <span id="thresh">0.5</span>
                </span> -->
                <!-- &rarr; -->
                <button id="do-stuff" onclick="call_linker()">Run â€º</button>
            </div>
             <div id="editor">
                <textarea id="text_input" class="CodeMirror cm-s-default CodeMirror-wrap CodeMirror-focused writer" rows="5" >Tuberculosis (TB) is an infectious disease usually caused by Mycobacterium tuberculosis (MTB) bacteria. Tuberculosis generally affects the lungs, but can also affect other parts of the body. Most infections show no symptoms, in which case it is known as latent tuberculosis. About 10% of latent infections progress to active disease which, if left untreated, kills about half of those affected. The classic symptoms of active TB are a chronic cough with blood-containing mucus, fever, night sweats, and weight loss. It was historically called "consumption" due to the weight loss. Infection of other organs can cause a wide range of symptoms.</textarea>
            </div>
           

            <div class="pane__bottom model__output ">
                <div class="pane__thumb"></div>
                <div class="model__content model__content--ner-output">
                    <div class="Form__FormField-sc-1mucple-0 hdCOWv">
                        <div id="results" class="passage model__content__summary highlight-container highlight-container--bottom-labels">   
                            
                           <!--  <span class="highlight bottom teal " data-label="ORG"> 
                            <span class="highlight__content">AllenNLP </span>
                            <span class="highlight__label"> <strong>ORG</strong> </span>
                            <span class="highlight__tooltip">Organization</span>
                            </span> <span>is </span>
                            <span>a </span>
                            <span class="highlight bottom blue " data-label="ORG"> 
                                <span class="highlight__content">PyTorch </span>
                                <span class="highlight__label"> <strong>ORG</strong> </span>
                                <span class="highlight__tooltip">Organization</span>
                            </span> 
                            <span>- </span>
                            <span>based </span>
                            <span>natural </span>
                            <span>language </span>
                            <span>processing </span>
                            <span>library </span>
                            <span>developed </span>
                            <span>at </span>
                            <span>the </span>
                            <span class="highlight bottom blue" data-label="ORG"> 
                                <span class="highlight__content">Allen Institute  for  Artificial  Intelligence a sdfasd fasd fasdf asdf asdf asdf asdf adf </span>
                                <span class="highlight__label"> <strong>ORG</strong> </span>
                                <span class="highlight__tooltip">Organization</span>
                            </span> 
                            <span>in </span>
                            <span class="highlight bottom green " data-label="LOC"> 
                                <span class="highlight__content">Seattle </span>
                                <span class="highlight__label"> <strong>LOC</strong> </span>
                                <span class="highlight__tooltip">Location</span>
                            </span> 
                            <span>. </span> -->

                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./medtype_ui/lodash.js"></script>
    <script>
        colors = ['fuchsia ', 'blue', 'red', 'green', 'purple', 'orange', 'pink', 'teal', 'cobalt', 'blue', 'red', 'green', 'purple', 'orange', 'pink', 'teal', 'cobalt', 'brown',  'gray', 'slate', 'tan']

        function add_token(token, info, is_annotated){
            var tag = document.createElement("span");
            if (is_annotated && info.length != 0){
                var rand_color = colors[Math.floor(Math.random() * colors.length)]
                var cui = info[0][0]
                token = _.trim(token)

                ele = '<span class="highlight bottom '+ rand_color +' " data-label="LOC"> \
                            <span class="highlight__content">'+ token + ' </span> \
                            <span class="highlight__label"> <strong>'+ cui +'</strong> </span> \
                            <span class="highlight__tooltip">'+ cui +'</span> \
                       </span>'

                $("#results").append(ele);
            }
            else{
                $("#results").append('<span>' + token + ' </span>');
            }
        }

        function update_results(resp){
             console.log(resp)

            $( "#results" ).empty();

            mentions = resp['result']['elinks'][0]['mentions']
            text     = resp['result']['elinks'][0]['text']
            offsets  = []

            if (mentions.length == 0){
                add_token(text, null, false)
            }

            else{
                mentions = _.sortBy(mentions, [function(x) {return x['start_offset'];} ])

                for (i=0; i < mentions.length; i++){
                    offsets.push([mentions[i]['start_offset'], mentions[i]['end_offset']])
                }
                console.log(offsets)

                first_start = offsets[0][0]
                if (first_start != 0){
                    tokens = text.substring(0, first_start).split(' ')
                    for (j=0; j < tokens.length; j++){
                        add_token(tokens[j], null, false)
                    }
                }

                for (i=0; i < offsets.length - 1; i++){
                    start     = offsets[i][0]
                    end       = offsets[i][1]
                    start_nxt = offsets[i+1][0]
                    end_nxt   = offsets[i+1][1]

                    add_token(text.substring(start, end), mentions[i]['filtered_candidates'], true)
                    tokens = text.substring(end, start_nxt).split(' ')
                    for (j=0; j < tokens.length; j++){
                        add_token(tokens[j], null, false)
                    }
                }

                last_start = offsets[offsets.length - 1][0]
                last_end   = offsets[offsets.length - 1][1]
                add_token(text.substring(last_start, last_end), mentions[mentions.length - 1]['filtered_candidates'], true)

                tokens = text.substring(last_end, text.length).split(' ')
                for (j=0; j < tokens.length; j++){
                    add_token(tokens[j], null, false)
                }
            }


            // console.log(mentions)
            // console.log(text)
        }

        function call_linker(){
            document.getElementById('model_picker').disabled = true;
            document.getElementById('linker_picker').disabled = true;

            text   = document.getElementById('text_input').value
            model  = document.getElementById('model_picker').value.toLowerCase()
            linker = document.getElementById('linker_picker').value.toLowerCase()

            msg  = {
                "id": Math.floor(Math.random() *  100000),
                "data": {
                    "text": [text],
                    "entity_linker": linker
                }
            }

            $.ajax({
                type: "POST",
                url: "http://brandy.lti.cs.cmu.edu:8125/run_linker",
                success: update_results,
                data: JSON.stringify(msg),
                dataType: "json",
                contentType: "application/json",
                error: function(e) {
                    console.log(e);
                },
            });

            document.getElementById('model_picker').disabled = false;
            document.getElementById('linker_picker').disabled = false;
        }

    </script>

    <!-- <canvas id="canvas"></canvas>
    <script src="./medtype_ui/demo-util.js"></script>
    <script src="./medtype_ui/codemirror.js"></script>
    <script src="./medtype_ui/tensor.js"></script>
    <script src="./medtype_ui/lstm.js"></script>
    <script src="./medtype_ui/scrollpastend.js"></script>
    <script src="./medtype_ui/placeholder.js"></script>
    <script src="./medtype_ui/models.js"></script>
    <script src="./medtype_ui/util.js"></script>
    <script>

        document.getElementById('model_picker').innerHTML = ''
        for(let k in models){
            document.getElementById('model_picker').appendChild(new Option(models[k].name || k, k))
        }
        
        
        
        var gl = TF.createGL(document.getElementById('canvas')),
            OutputTensor = TF.OutputTensor,
            Tensor = TF.Tensor,
            InPlaceTensor = TF.InPlaceTensor;
        
        
        
        function destroyTensors(tensors){
            for(var i = 0; i < tensors.length; i++){
                if(tensors[i]){
                    tensors[i].destroy()
                }
            }
        }
        
        var allLSTMWeights = [], allLSTMStates = [], denseWeights, denseBias, oneHotVector, charTensor, state, denseOutput, buffer;
        
        async function loadModel(){
            document.getElementById('toolbar').style.display = ''
            document.getElementById('model_picker').disabled = true;
            document.getElementById('temperature').disabled = true;
        
            var m = models[document.getElementById('model_picker').value],
                Ns = m.Ns, Ni = m.Ni;
            
            console.assert(Ni == m.chars.length);
        
            destroyTensors(allLSTMWeights.concat(allLSTMStates, [ denseWeights, denseBias, oneHotVector, charTensor, state, denseOutput, buffer ]))
        
            allLSTMWeights = []
            allLSTMStates = []
        
            for(var i = 0; i < (m.layers || 1); i++){
                allLSTMWeights.push(new Tensor(gl, await loadArrayFromURL(m.path + '/lstm_' + (i+1) + '_combined-'+Ns+'x' + (Ns+( i === 0 ? Ni : Ns)+1) + 'x4')))
                allLSTMStates.push(new InPlaceTensor(gl, [Ns, 1, 4]))
            }
            // lstm1Weights = new Tensor(gl, await loadArrayFromURL(m.path + '/lstm_1_combined-'+Ns+'x' + (Ns+Ni+1) + 'x4'));
        
            denseWeights = new Tensor(gl, await loadArrayFromURL(m.path + '/dense_1-weights-kernel-'+Ns+'x'+Ni))
            denseBias = new Tensor(gl, await loadArrayFromURL(m.path + '/dense_1-weights-bias-'+Ni))
        
        
            oneHotVector = new OutputTensor(gl, [Ni, 1, 4])
            charTensor = new OutputTensor(gl, [1])
            // state1 = new InPlaceTensor(gl, [Ns, 1, 4])
            // state2 = new InPlaceTensor(gl, [Ns, 1, 4])
            denseOutput = new OutputTensor(gl, [Ni, 1, 4])
            buffer = new InPlaceTensor(gl, [ 1, 1, 1, 200 ])
        
            document.getElementById('model_picker').disabled = false;
            document.getElementById('temperature').disabled = false;
            
        }
        
        loadModel()
        
        async function generateCompletion(input, temperature = 0.7){
            var m = models[document.getElementById('model_picker').value],
                Ns = m.Ns, Ni = m.Ni, chars = m.chars;
        
            var startTime = Date.now()
        
            input = input.split('').filter(k => chars.indexOf(k) != -1).join('')
        
            for(let i = 0; i < buffer.shape[3]; i++){
                if(i < input.length)
                    charTensor.update(ndpack([[ chars.indexOf(input[i]), 0, 0, 0 ]]));
                
                oneHotVector.run(OneHot, { data: charTensor })
                // state.run(LSTM, { X: oneHotVector, prev: state, W: lstm1Weights })
                var previousResult = oneHotVector;
                for(var j = 0; j < allLSTMWeights.length; j++){
                    allLSTMStates[j].run(LSTM, { X: previousResult, prev: allLSTMStates[j], W: allLSTMWeights[j] })
                    previousResult = allLSTMStates[j];
                }
        
                denseOutput.run(FullyConnected, { inputs: previousResult, b: denseBias, W: denseWeights })
                charTensor.run(WarmSample, { data: denseOutput, temperature: temperature, random: Math.random() })
                buffer.run(TextureBuffer, { buffer: buffer, data: charTensor, index: i })
            }
        
        
            await buffer.ready();
            // buffer._show({ scale: 1 / Ni })
        
            var message = Array.from(buffer.read().data).map(k => chars[k]).join('').slice(input.length - 1)
            console.log('%c' + input + '%c' + message, 'color: black', 'color: blue');
            return message;
        }
        
        
        
        var cm = CodeMirror(document.getElementById('editor'), {
            value: '',
            lineWrapping: true,
            cursorScrollMargin: 50,
            extraKeys: {
                Tab: function(cm){
                    setTimeout(updateCompletion, 20);
                },
            },
            viewportMargin: Infinity,
            // scrollPastEnd: true,
            // placeholder: innerWidth < 700 ? 'Swipe right to cycle between synthesized sentences.' : 'Hit Tab to cycle between synthesized sentences.'
        });
        
        
        
        cm.on('refresh', function(){
            // var oh = document.getElementById('preamble').offsetHeight
        
            // if (cm.state.preamblePadding != oh) {
            //     // console.log(oh)
            //     cm.display.lineSpace.parentNode.style.paddingTop = (oh + 50) + 'px';
            // }
        })
        
        
        var abortTyping = false;
        cm.on('keydown', function(){
            abortTyping = true;
            // console.log('abort')
        })
        
        cm.refresh()
        cm.focus()
        
        var isGenerating = false;
        async function updateCompletion(){
            if(document.getElementById('model_picker').disabled) return;
            if(isGenerating) return;
            isGenerating = true;
            abortTyping = false
            // let attempt = Date.now();
            // currentCompletion = attempt;
            var m = models[document.getElementById('model_picker').value]
        
            var leadingText = (m.prefix + cm.getRange({ line: 0, ch: 0 }, cm.getCursor('from'))).slice(-100);
            var waitEl = document.createElement('span')
            waitEl.className = 'waiting'
            // waitEl.innerHTML = '...'
            // cm.setBookmark(cm.getCursor('from'), {
            //     widget: waitEl
            // })
        
            if(!cm.getSelection()) cm.replaceSelection('#', 'around');
        
            var mark = cm.markText(cm.getCursor('from'), cm.getCursor('to'), {
                replacedWith: waitEl,
                clearWhenEmpty: false,
                atomic: true
            })
            cm.setSelection(cm.getCursor('to'))
        
            // return;
        
            
            var text = null;
            await nextFrame();
        
            // if(currentCompletion != attempt) return;
        
            var raw_completion = await generateCompletion(leadingText, +document.getElementById('temperature').value);
            try {
                text = raw_completion.match(/^.*?((\.|\!|\;)+\s+)/)[0]
            } catch (err) {
                text = raw_completion.split(' ').slice(0, -2).join(' ')
            }
            
            if(text){
                // console.log('new text', text)
                // var f = mark.find();
                
                // mark.clear()
                // cm.setSelection(f.from, f.to)
                // cm.replaceRange(text, f.from, f.to)
                // cm.replaceSelection(text, 'around')
        
                for(var i = 0; i < text.length; i++){
                    // if(currentCompletion != attempt) return;
                    if(abortTyping) break;
                    
                    let f = mark.find();
                    mark.clear()
                    cm.setSelection(f.from, f.to)
                    cm.replaceSelection(text.slice(0, i + 1), 'around')
                    mark = cm.markText(cm.getCursor('from'), cm.getCursor('to'))
        
                    await nextFrame();
                }
        
                // cm.replaceSelection(text, 'around')
                let f = mark.find();
                mark.clear()
                cm.setSelection(f.from, f.to)
                cm.replaceSelection(text, 'around')
                mark = cm.markText(cm.getCursor('from'), cm.getCursor('to'))
        
            }else{
                console.warn('unable to find complete sentence', leadingText)
            }
        
            isGenerating = false;
        }
        
        
        async function typeInitialText(){
            // let text = cm.options.placeholder;
            let text = innerWidth < 700 ? 'Swipe right to cycle between synthesized sentences.' : 'Hit Tab to cycle between synthesized sentences.'
            await nextFrame();
            for(var i = 0; i < text.length; i++){
                // if(currentCompletion != attempt) return;
                if(abortTyping) break;
                
                // let f = mark.find();
                // mark.clear()
                // cm.setSelection(f.from, f.to)
                // cm.replaceSelection(text.slice(0, i + 1), 'around')
                if(text[i] == ' '){
                    await nextFrame();
                    await nextFrame();
                    await nextFrame();
                }
        
                cm.setOption('placeholder', text.slice(0, i + 1))
                // mark = cm.markText(cm.getCursor('from'), cm.getCursor('to'))
        
                await nextFrame();
                await nextFrame();
            }
        }
        
        setTimeout(typeInitialText, 500)
        
        // https://stackoverflow.com/a/23230280/205784
        document.addEventListener('touchstart', handleTouchStart, false);        
        document.addEventListener('touchmove', handleTouchMove, false);
        var xDown = null;                                                        
        var yDown = null;                                                        
        function handleTouchStart(evt) {                                         
            xDown = evt.touches[0].clientX;                                      
            yDown = evt.touches[0].clientY;                                      
        };                                                
        function handleTouchMove(evt) {
            if ( ! xDown || ! yDown ) return;
            var xUp = evt.touches[0].clientX;                                    
            var yUp = evt.touches[0].clientY;
            var xDiff = xDown - xUp;
            var yDiff = yDown - yUp;
            if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
                if ( xDiff > 0 ) {
                    /* left swipe */ 
                } else {
                    updateCompletion()
                }                       
            }
            xDown = null;
            yDown = null;                                             
        };
    </script>
    <script async="" src="./medtype_ui/js"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'UA-83153710-9');
    </script> -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <!-- <iframe scrolling="no" frameborder="0" allowtransparency="true" src="./medtype_ui/widget_iframe.2a008290075125adde2d7b849b06a0bb.html" title="Twitter settings iframe" style="display: none;"></iframe> -->
</body>

</html>